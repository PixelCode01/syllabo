name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: Windows
            executable: syllabo.exe
            archive_ext: zip
          - os: ubuntu-latest
            platform: Linux
            executable: syllabo
            archive_ext: tar.gz
          - os: macos-latest
            platform: macOS
            executable: syllabo
            archive_ext: tar.gz

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller setuptools wheel
        pip install -r requirements.txt

    - name: Create version file
      run: |
        echo "VERSION = '${{ github.ref_name || github.event.inputs.version }}'" > src/version.py

    - name: Build standalone executable
      run: |
        echo "Building standalone executable using PyInstaller spec file..."
        pyinstaller --clean --noconfirm syllabo.spec
        
    - name: Verify executable
      run: |
        echo "Verifying standalone executable..."
        ls -la dist/
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          dist/syllabo.exe --help || echo "Executable test failed but continuing..."
        else
          ./dist/syllabo --help || echo "Executable test failed but continuing..."
        fi

    - name: Create installer scripts
      run: python build-all-platforms.py

    - name: Create package directory
      run: |
        mkdir -p release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}

    - name: Copy files to package (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        copy dist\syllabo.exe release\syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}\
        copy install-windows.bat release\syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}\
        copy uninstall-windows.bat release\syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}\
        copy .env.example release\syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}\
        if exist LICENSE copy LICENSE release\syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}\

    - name: Copy files to package (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cp dist/syllabo release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/
        cp install-${{ matrix.platform == 'macOS' && 'macos' || 'linux' }}.sh release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/
        cp uninstall-unix.sh release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/
        cp .env.example release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/
        [ -f LICENSE ] && cp LICENSE release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/ || true
        chmod +x release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/syllabo
        chmod +x release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/*.sh

    - name: Create README for package
      run: |
        cat > release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}/README.txt << 'EOF'
        # Syllabo ${{ github.ref_name || github.event.inputs.version }} - ${{ matrix.platform }} Package
        
        ## Quick Start
        
        ### Automatic Installation (Recommended)
        ${{ matrix.os == 'windows-latest' && '
        1. Right-click on `install-windows.bat`
        2. Select "Run as administrator"
        3. Follow the installation prompts
        4. Open Command Prompt and run: `syllabo interactive`' || '
        1. Open terminal in this directory
        2. Run: `chmod +x install-*.sh`
        3. Run: `./install-*.sh`
        4. Restart your terminal
        5. Run: `syllabo interactive`' }}
        
        ### Manual Installation
        
        1. Copy the executable to a directory in your PATH
        2. Copy `.env.example` to your preferred config location
        3. Make executable (Linux/macOS): `chmod +x syllabo`
        4. Run: `syllabo interactive`
        
        ## Usage
        
        ```bash
        # Interactive mode (recommended for beginners)
        syllabo interactive
        
        # Analyze a syllabus
        syllabo analyze --file syllabus.pdf
        
        # Generate quiz
        syllabo quiz --topic "Machine Learning" --num-questions 5
        
        # View progress
        syllabo progress
        
        # Get help
        syllabo --help
        ```
        
        ## Configuration (Optional)
        
        For enhanced features, configure API keys:
        
        1. Copy `.env.example` to `.env`
        2. Edit `.env` and add your API keys:
           ```
           GOOGLE_API_KEY=your_youtube_api_key_here
           GEMINI_API_KEY=your_gemini_api_key_here
           ```
        
        ## Features
        
        - 📚 Syllabus analysis and topic extraction
        - 🧠 AI-powered quiz generation
        - 📊 Progress tracking and analytics
        - 🎯 Study goals and milestones
        - 🔄 Spaced repetition system
        - 🎥 Video analysis and bookmarking
        - 🔍 Multi-platform resource search
        - ⏱️ Pomodoro study sessions
        
        ## Support
        
        - Documentation: https://github.com/PixelCode01/syllabo
        - Issues: https://github.com/PixelCode01/syllabo/issues
        - Discussions: https://github.com/PixelCode01/syllabo/discussions
        
        ## Uninstallation
        
        ${{ matrix.os == 'windows-latest' && 'Run `uninstall-windows.bat` as administrator' || 'Run `./uninstall-unix.sh`' }}
        
        ---
        
        **Syllabo ${{ github.ref_name || github.event.inputs.version }}** - AI-Powered Learning Assistant
        Built with ❤️ for learners everywhere
        EOF

    - name: Create archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd release
        powershell Compress-Archive -Path "syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}" -DestinationPath "syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}.zip"

    - name: Create archive (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cd release
        tar -czf syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}.tar.gz syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: syllabo-${{ matrix.platform }}
        path: release/syllabo-${{ github.ref_name || github.event.inputs.version }}-${{ matrix.platform }}.${{ matrix.archive_ext }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: ls -la artifacts/

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        name: Syllabo ${{ github.ref_name || github.event.inputs.version }}
        body: |
          ## 🎓 Syllabo ${{ github.ref_name || github.event.inputs.version }} - Standalone Release
          
          **✅ No Python Required • ✅ No Dependencies • ✅ Just Download & Run**
          
          ### 📦 Standalone Downloads
          
          Choose the package for your operating system - completely self-contained executables:
          
          | Platform | Download | Size | Requirements |
          |----------|----------|------|--------------|
          | 🪟 **Windows** | [`syllabo-${{ github.ref_name || github.event.inputs.version }}-Windows.zip`](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name || github.event.inputs.version }}/syllabo-${{ github.ref_name || github.event.inputs.version }}-Windows.zip) | ~30MB | Windows 10/11 (64-bit) |
          | 🐧 **Linux** | [`syllabo-${{ github.ref_name || github.event.inputs.version }}-Linux.tar.gz`](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name || github.event.inputs.version }}/syllabo-${{ github.ref_name || github.event.inputs.version }}-Linux.tar.gz) | ~35MB | Any Linux distribution |
          | 🍎 **macOS** | [`syllabo-${{ github.ref_name || github.event.inputs.version }}-macOS.tar.gz`](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name || github.event.inputs.version }}/syllabo-${{ github.ref_name || github.event.inputs.version }}-macOS.tar.gz) | ~35MB | macOS 10.15+ (Intel & Apple Silicon) |
          
          ### 🚀 Quick Start (30 seconds!)
          
          **Windows:**
          1. Download and extract the ZIP file
          2. Right-click `install-windows.bat` → "Run as administrator"
          3. Open Command Prompt and run: `syllabo interactive`
          
          **Linux/macOS:**
          ```bash
          # Download and extract
          tar -xzf syllabo-*-Linux.tar.gz  # or macOS.tar.gz
          cd syllabo-*
          
          # Install (adds to PATH)
          chmod +x install-*.sh
          ./install-*.sh
          
          # Start using
          syllabo interactive
          ```
          
          **Portable Mode (No Installation):**
          Just extract and run the executable directly - no installation needed!
          
          ### ✨ What's New in This Release
          
          - 🔧 **Truly Standalone**: No Python or dependencies required
          - 📦 **Smaller Size**: Optimized builds with better compression
          - 🚀 **Faster Startup**: Improved loading times
          - 🛠️ **Better Installers**: Automatic PATH setup and desktop shortcuts
          - 🔒 **Enhanced Security**: Signed executables (where possible)
          
          ### 🎯 Core Features
          
          - 📚 **Syllabus Analysis** - Extract topics from any study material
          - 🧠 **AI Quiz Generation** - Create personalized quizzes instantly
          - 📊 **Progress Tracking** - Monitor your learning journey
          - 🎯 **Study Goals** - Set and achieve learning milestones
          - 🔄 **Spaced Repetition** - Scientifically-backed memory retention
          - 🎥 **Video Analysis** - Smart bookmarks and content extraction
          - 🔍 **Resource Search** - Find learning materials across platforms
          - ⏱️ **Study Sessions** - Pomodoro timer and focus tools
          
          ### 📖 Documentation & Support
          
          - 🌐 **Website**: [syllabo.github.io](https://${{ github.repository_owner }}.github.io/syllabo)
          - 📋 **Installation Guide**: [INSTALLATION.md](https://github.com/${{ github.repository }}/blob/main/INSTALLATION.md)
          - 📚 **User Guide**: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          - 🔑 **API Setup**: [docs/API_SETUP.md](https://github.com/${{ github.repository }}/blob/main/docs/API_SETUP.md)
          - 🐛 **Report Issues**: [GitHub Issues](https://github.com/${{ github.repository }}/issues/new)
          - 💬 **Discussions**: [GitHub Discussions](https://github.com/${{ github.repository }}/discussions)
          
          ### 🔧 For Developers
          
          - 🏗️ **Build Guide**: [BUILD.md](https://github.com/${{ github.repository }}/blob/main/BUILD.md)
          - 🤝 **Contributing**: [CONTRIBUTING.md](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)
          - 📜 **License**: [MIT License](https://github.com/${{ github.repository }}/blob/main/LICENSE)
          
          ### 🛡️ Security & Trust
          
          - ✅ **Open Source**: Full source code available
          - 🔍 **Transparent Builds**: All builds via GitHub Actions
          - 🛡️ **No Telemetry**: Your data stays on your device
          - 🔒 **Privacy First**: No account required, works offline
          
          ---
          
          **🎓 Happy Learning!** Built with ❤️ for students and lifelong learners everywhere.
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v1.0.0...${{ github.ref_name || github.event.inputs.version }}
        draft: false
        prerelease: false
        files: |
          artifacts/syllabo-Windows/syllabo-${{ github.ref_name || github.event.inputs.version }}-Windows.zip
          artifacts/syllabo-Linux/syllabo-${{ github.ref_name || github.event.inputs.version }}-Linux.tar.gz
          artifacts/syllabo-macOS/syllabo-${{ github.ref_name || github.event.inputs.version }}-macOS.tar.gz

    - name: Generate release checksums
      run: |
        cd artifacts
        find . -name "*.zip" -o -name "*.tar.gz" | while read file; do
          echo "Generating checksum for $file"
          sha256sum "$file" >> checksums.txt
        done
        echo "Generated checksums:"
        cat checksums.txt
        
    - name: Upload checksums to release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        files: artifacts/checksums.txt

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Create GitHub Pages site
      run: |
        mkdir -p _site
        
        # Create index.html
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Syllabo - AI-Powered Learning Assistant</title>
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                }
                
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 2rem;
                }
                
                .hero {
                    text-align: center;
                    color: white;
                    margin-bottom: 4rem;
                }
                
                .hero h1 {
                    font-size: 3.5rem;
                    margin-bottom: 1rem;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                }
                
                .hero p {
                    font-size: 1.3rem;
                    margin-bottom: 2rem;
                    opacity: 0.9;
                }
                
                .download-section {
                    background: white;
                    border-radius: 15px;
                    padding: 3rem;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    margin-bottom: 3rem;
                }
                
                .download-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 2rem;
                    margin-top: 2rem;
                }
                
                .download-card {
                    border: 2px solid #e1e5e9;
                    border-radius: 10px;
                    padding: 2rem;
                    text-align: center;
                    transition: all 0.3s ease;
                }
                
                .download-card:hover {
                    border-color: #667eea;
                    transform: translateY(-5px);
                    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
                }
                
                .download-card h3 {
                    font-size: 1.5rem;
                    margin-bottom: 1rem;
                    color: #333;
                }
                
                .download-card .os-icon {
                    font-size: 3rem;
                    margin-bottom: 1rem;
                }
                
                .download-btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 24px;
                    text-decoration: none;
                    border-radius: 25px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    margin-top: 1rem;
                }
                
                .download-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
                }
                
                .features {
                    background: white;
                    border-radius: 15px;
                    padding: 3rem;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    margin-bottom: 3rem;
                }
                
                .features-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 2rem;
                    margin-top: 2rem;
                }
                
                .feature-card {
                    text-align: center;
                    padding: 1.5rem;
                }
                
                .feature-card .emoji {
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }
                
                .feature-card h4 {
                    font-size: 1.2rem;
                    margin-bottom: 0.5rem;
                    color: #333;
                }
                
                .feature-card p {
                    color: #666;
                    font-size: 0.9rem;
                }
                
                .footer {
                    text-align: center;
                    color: white;
                    opacity: 0.8;
                    margin-top: 3rem;
                }
                
                .footer a {
                    color: white;
                    text-decoration: none;
                    font-weight: 600;
                }
                
                .footer a:hover {
                    text-decoration: underline;
                }
                
                @media (max-width: 768px) {
                    .hero h1 {
                        font-size: 2.5rem;
                    }
                    
                    .container {
                        padding: 1rem;
                    }
                    
                    .download-section, .features {
                        padding: 2rem;
                    }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="hero">
                    <h1>🎓 Syllabo</h1>
                    <p>AI-Powered Learning Assistant</p>
                    <p>Transform your study materials into interactive learning experiences</p>
                </div>
                
                <div class="download-section">
                    <h2 style="text-align: center; margin-bottom: 1rem; color: #333;">Download Latest Release</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 2rem;">Choose your platform and start learning smarter today!</p>
                    
                    <div class="download-grid">
                        <div class="download-card">
                            <div class="os-icon">🪟</div>
                            <h3>Windows</h3>
                            <p>Windows 10/11 (64-bit)</p>
                            <a href="https://github.com/PixelCode01/syllabo/releases/latest/download/syllabo-latest-Windows.zip" class="download-btn">Download for Windows</a>
                        </div>
                        
                        <div class="download-card">
                            <div class="os-icon">🐧</div>
                            <h3>Linux</h3>
                            <p>Ubuntu, Debian, CentOS, etc.</p>
                            <a href="https://github.com/PixelCode01/syllabo/releases/latest/download/syllabo-latest-Linux.tar.gz" class="download-btn">Download for Linux</a>
                        </div>
                        
                        <div class="download-card">
                            <div class="os-icon">🍎</div>
                            <h3>macOS</h3>
                            <p>macOS 10.15+ (Intel & Apple Silicon)</p>
                            <a href="https://github.com/PixelCode01/syllabo/releases/latest/download/syllabo-latest-macOS.tar.gz" class="download-btn">Download for macOS</a>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <p style="color: #666;">Or view all releases on <a href="https://github.com/PixelCode01/syllabo/releases" style="color: #667eea; text-decoration: none; font-weight: 600;">GitHub</a></p>
                    </div>
                </div>
                
                <div class="features">
                    <h2 style="text-align: center; margin-bottom: 1rem; color: #333;">Features</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 2rem;">Everything you need for effective learning</p>
                    
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="emoji">📚</div>
                            <h4>Syllabus Analysis</h4>
                            <p>Extract topics and create structured learning paths from any syllabus</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">🧠</div>
                            <h4>AI Quiz Generation</h4>
                            <p>Generate personalized quizzes from your study materials using AI</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">📊</div>
                            <h4>Progress Tracking</h4>
                            <p>Monitor your learning progress with detailed analytics and insights</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">🎯</div>
                            <h4>Study Goals</h4>
                            <p>Set and track learning goals with milestone management</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">🔄</div>
                            <h4>Spaced Repetition</h4>
                            <p>Optimize retention with scientifically-backed spaced repetition</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">🎥</div>
                            <h4>Video Analysis</h4>
                            <p>Analyze educational videos and create smart bookmarks</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">🔍</div>
                            <h4>Resource Search</h4>
                            <p>Find relevant learning resources across multiple platforms</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="emoji">⏱️</div>
                            <h4>Study Sessions</h4>
                            <p>Pomodoro timer and focus sessions for productive studying</p>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    <p>Built with ❤️ for learners everywhere</p>
                    <p><a href="https://github.com/PixelCode01/syllabo">View on GitHub</a> | <a href="https://github.com/PixelCode01/syllabo/issues">Report Issues</a> | <a href="https://github.com/PixelCode01/syllabo/blob/main/INSTALLATION.md">Documentation</a></p>
                </div>
            </div>
        </body>
        </html>
        EOF

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '_site'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2